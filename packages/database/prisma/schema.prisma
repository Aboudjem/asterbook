// Asterbook Database Schema
// Converted from PHP/MySQL to Prisma (SQLite for local dev)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==================== USER SYSTEM ====================

model User {
  id                   Int       @id @default(autoincrement())
  username             String    @unique
  email                String    @unique
  password             String
  avatar               String?
  profileBanner        String?   @map("profile_banner")
  bio                  String?
  socialDiscord        String?   @map("social_discord")
  socialTwitter        String?   @map("social_twitter")
  socialPortfolio      String?   @map("social_portfolio")
  wallet               String?
  isPremium            Boolean   @default(false) @map("is_premium")
  premiumExpiresAt     DateTime? @map("premium_expires_at")
  premiumTrialUsed     Boolean   @default(false) @map("premium_trial_used")
  paymentStatus        String    @default("none") @map("payment_status")
  txHash               String?   @map("tx_hash")
  stardustCoins        BigInt    @default(0) @map("stardust_coins")
  totalOnlineTime      BigInt    @default(0) @map("total_online_time")
  lastSeen             DateTime? @map("last_seen")
  isFrozen             Boolean   @default(false) @map("is_frozen")
  activeBannerId       Int?      @map("active_banner_id")
  activeBorderId       Int?      @map("active_border_id")
  activeNameEffectId   Int?      @map("active_name_effect_id")
  createdAt            DateTime  @default(now()) @map("created_at")

  pet                  UserPet?
  balance              UserBalance?
  inventory            UserInventory[]
  arenaBattles         ArenaBattle[]
  createdLobbies       ArenaLobby[]      @relation("LobbyCreator")
  joinedLobbies        ArenaLobby[]      @relation("LobbyJoiner")
  wonLobbies           ArenaLobby[]      @relation("LobbyWinner")
  stakingVaults        StakingVault[]
  dailyQuests          DailyQuest[]
  marketplaceComponents MarketplaceComponent[]
  marketplacePurchases MarketplacePurchase[]
  apiKeys              ApiKey[]
  sentinelSnapshot     SentinelSnapshot?
  sentinelAlerts       SentinelAlert[]
  chatParticipations   ChatParticipant[]
  sentMessages         ChatMessage[]
  predictionVote       AsterPredictionVote?
  promoUsages          UserPromoUsage[]

  @@map("users")
}

model UserBalance {
  userId  Int   @id @map("user_id")
  balance Float @default(1000.00)
  user    User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_balances")
}

// ==================== PET SYSTEM ====================

model UserPet {
  id                 Int       @id @default(autoincrement())
  userId             Int       @unique @map("user_id")
  petType            String    @default("dragon_egg") @map("pet_type")
  stage              Int       @default(1)
  hunger             Int       @default(50)
  evolutionProgress  Int       @default(0) @map("evolution_progress")
  rarity             String?
  element            String?
  expeditionStatus   String    @default("idle") @map("expedition_status")
  expeditionEnd      DateTime? @map("expedition_end")
  lastFed            DateTime  @default(now()) @map("last_fed")
  createdAt          DateTime  @default(now()) @map("created_at")

  user               User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  arenaBattles       ArenaBattle[]

  @@map("user_pets")
}

// ==================== ARENA SYSTEM ====================

model ArenaBattle {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  petId        Int      @map("pet_id")
  betAmount    Float    @map("bet_amount")
  feeAmount    Float    @map("fee_amount")
  winChance    Float    @map("win_chance")
  result       String
  rewardAmount Float    @map("reward_amount")
  createdAt    DateTime @default(now()) @map("created_at")

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  pet          UserPet  @relation(fields: [petId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("arena_battles")
}

model ArenaLobby {
  id         Int       @id @default(autoincrement())
  creatorId  Int       @map("creator_id")
  joinerId   Int?      @map("joiner_id")
  betAmount  Float     @map("bet_amount")
  status     String    @default("waiting")
  winnerId   Int?      @map("winner_id")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  creator    User      @relation("LobbyCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  joiner     User?     @relation("LobbyJoiner", fields: [joinerId], references: [id])
  winner     User?     @relation("LobbyWinner", fields: [winnerId], references: [id])

  @@index([creatorId])
  @@index([status])
  @@map("arena_lobbies")
}

// ==================== STAKING SYSTEM ====================

model StakingVault {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  amount       Float
  apy          Int
  durationDays Int       @map("duration_days")
  status       String    @default("active")
  startTime    DateTime  @default(now()) @map("start_time")
  endTime      DateTime  @map("end_time")
  claimedAt    DateTime? @map("claimed_at")

  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("staking_vaults")
}

// ==================== SHOP SYSTEM ====================

model ShopItem {
  id           Int      @id @default(autoincrement())
  name         String
  description  String?
  price        Float
  imageUrl     String?  @map("image_url")
  category     String
  isAnimated   Boolean  @default(false) @map("is_animated")
  minRankLevel Int      @default(0) @map("min_rank_level")
  createdAt    DateTime @default(now()) @map("created_at")

  inventory    UserInventory[]

  @@map("shop_items")
}

model UserInventory {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  itemId     Int      @map("item_id")
  acquiredAt DateTime @default(now()) @map("acquired_at")

  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  item       ShopItem @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([userId, itemId])
  @@map("user_inventory")
}

// ==================== QUEST SYSTEM ====================

model DailyQuest {
  id              Int      @id @default(autoincrement())
  userId          Int      @map("user_id")
  questType       String   @map("quest_type")
  description     String?
  targetCount     Int      @default(1) @map("target_count")
  currentProgress Int      @default(0) @map("current_progress")
  rewardAmount    Int      @default(50) @map("reward_amount")
  status          String   @default("active")
  dateAssigned    DateTime @map("date_assigned")
  batchId         String?  @map("batch_id")

  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dateAssigned])
  @@index([batchId])
  @@map("daily_quests")
}

// ==================== MARKETPLACE SYSTEM ====================

model MarketplaceComponent {
  id          Int      @id @default(autoincrement())
  userId      Int      @map("user_id")
  title       String
  description String?
  price       Float    @default(0)
  category    String?
  codeSnippet String?  @map("code_snippet")
  demoHtml    String?  @map("demo_html")
  demoCss     String?  @map("demo_css")
  demoJs      String?  @map("demo_js")
  createdAt   DateTime @default(now()) @map("created_at")

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  purchases   MarketplacePurchase[]

  @@map("marketplace_components")
}

model MarketplacePurchase {
  id          Int      @id @default(autoincrement())
  buyerId     Int      @map("buyer_id")
  componentId Int      @map("component_id")
  pricePaid   Float    @map("price_paid")
  licenseKey  String   @map("license_key")
  purchasedAt DateTime @default(now()) @map("purchased_at")

  buyer       User     @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  component   MarketplaceComponent @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@map("marketplace_purchases")
}

// ==================== DEVELOPER API SYSTEM ====================

model ApiKey {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  name       String
  apiKey     String    @unique @map("api_key")
  apiKeyHash String    @map("api_key_hash")
  status     String    @default("active")
  createdAt  DateTime  @default(now()) @map("created_at")
  lastUsedAt DateTime? @map("last_used_at")

  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  usages     ApiUsage[]

  @@index([userId])
  @@map("api_keys")
}

model ApiUsage {
  id        Int      @id @default(autoincrement())
  apiKeyId  Int      @map("api_key_id")
  endpoint  String
  method    String
  cost      Int      @default(1)
  createdAt DateTime @default(now()) @map("created_at")

  apiKey    ApiKey   @relation(fields: [apiKeyId], references: [id], onDelete: Cascade)

  @@index([apiKeyId])
  @@map("api_usages")
}

// ==================== SECURITY SYSTEM (SENTINEL) ====================

model SentinelSnapshot {
  userId        Int      @id @map("user_id")
  lastBalance   BigInt   @default(0) @map("last_balance")
  lastCheckTime DateTime @default(now()) @map("last_check_time")

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sentinel_snapshots")
}

model SentinelAlert {
  id        Int      @id @default(autoincrement())
  userId    Int      @map("user_id")
  ruleName  String   @map("rule_name")
  details   String?
  severity  String   @default("high")
  createdAt DateTime @default(now()) @map("created_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sentinel_alerts")
}

// ==================== CHAT SYSTEM ====================

model ChatRoom {
  id           Int       @id @default(autoincrement())
  type         String    @default("direct")
  createdAt    DateTime  @default(now()) @map("created_at")

  participants ChatParticipant[]
  messages     ChatMessage[]

  @@map("chat_rooms")
}

model ChatParticipant {
  id         Int      @id @default(autoincrement())
  roomId     Int      @map("room_id")
  userId     Int      @map("user_id")
  joinedAt   DateTime @default(now()) @map("joined_at")

  room       ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([roomId, userId])
  @@map("chat_participants")
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  roomId    Int      @map("room_id")
  senderId  Int      @map("sender_id")
  message   String
  createdAt DateTime @default(now()) @map("created_at")

  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  sender    User     @relation(fields: [senderId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@map("chat_messages")
}

// ==================== OTHER TABLES ====================

model AsterPredictionVote {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique @map("user_id")
  voteType  String   @map("vote_type")
  updatedAt DateTime @updatedAt @map("updated_at")

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("aster_prediction_votes")
}

model PromoCode {
  id           Int       @id @default(autoincrement())
  code         String    @unique
  rewardType   String    @map("reward_type")
  rewardAmount Int       @map("reward_amount")
  maxUses      Int?      @map("max_uses")
  currentUses  Int       @default(0) @map("current_uses")
  expiresAt    DateTime? @map("expires_at")
  isActive     Boolean   @default(true) @map("is_active")
  createdAt    DateTime  @default(now()) @map("created_at")

  usages       UserPromoUsage[]

  @@map("promo_codes")
}

model UserPromoUsage {
  id        Int       @id @default(autoincrement())
  userId    Int       @map("user_id")
  promoId   Int       @map("promo_id")
  usedAt    DateTime  @default(now()) @map("used_at")

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  promo     PromoCode @relation(fields: [promoId], references: [id], onDelete: Cascade)

  @@unique([userId, promoId])
  @@map("user_promo_usages")
}
